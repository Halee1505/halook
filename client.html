<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ESP32 Control Knobs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg-gradient: radial-gradient(circle at top, #4f46e5, #020617);
        --glass-bg: rgba(15, 23, 42, 0.45);
        --glass-border: rgba(148, 163, 184, 0.5);
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.25);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg-gradient);
        color: var(--text-main);
        padding: 16px;
      }

      .panel {
        width: 100%;
        max-width: 900px;
        background: var(--glass-bg);
        border-radius: 24px;
        padding: 24px 20px 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 24px 80px rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(20px) saturate(150%);
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 8px;
        flex-wrap: wrap;
      }

      .panel-title {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .panel-subtitle {
        font-size: 13px;
        color: var(--text-muted);
      }

      .status-chip {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--accent-soft);
        font-size: 11px;
        background: rgba(15, 23, 42, 0.8);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #f97316;
        box-shadow: 0 0 8px rgba(249, 115, 22, 0.8);
      }

      .status-text {
        color: var(--text-muted);
      }

      .knob-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 18px;
      }

      @media (max-width: 720px) {
        .panel {
          padding: 18px 14px 16px;
        }
        .panel-title {
          font-size: 18px;
        }
        .knob-grid {
          grid-template-columns: 1fr;
        }
      }

      .knob-card {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 20px;
        padding: 16px 12px 14px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .knob-label {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
      }

      .knob-wrapper {
        position: relative;
        width: 140px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none;
      }

      @media (max-width: 480px) {
        .knob-wrapper {
          width: 120px;
          height: 120px;
        }
      }

      .knob-ring {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(248, 250, 252, 0.15),
            transparent 55%
          ),
          conic-gradient(from 220deg, var(--accent-soft), transparent 210deg);
        border: 1px solid rgba(148, 163, 184, 0.6);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9),
          0 10px 30px rgba(15, 23, 42, 0.8);
      }

      .knob-track {
        position: absolute;
        inset: 18px;
        border-radius: 50%;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(248, 250, 252, 0.22),
            transparent 60%
          ),
          rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.6);
        mask: radial-gradient(circle 52% at 50% 50%, transparent 60%, #000 61%);
        -webkit-mask: radial-gradient(
          circle 52% at 50% 50%,
          transparent 60%,
          #000 61%
        );
      }

      .knob-track-arc {
        position: absolute;
        inset: 22px;
        border-radius: 50%;
        background: conic-gradient(
          from 225deg,
          rgba(51, 65, 85, 0.8) 0deg,
          rgba(51, 65, 85, 0.8) 270deg,
          transparent 270deg,
          transparent 360deg
        );
        opacity: 0.9;
      }

      .knob-track-arc-active {
        position: absolute;
        inset: 22px;
        border-radius: 50%;
        background: conic-gradient(
          from 225deg,
          var(--accent) 0deg,
          var(--accent) var(--angle, 0deg),
          transparent var(--angle, 0deg),
          transparent 360deg
        );
        opacity: 0.95;
      }

      .knob-core {
        position: relative;
        width: 74px;
        height: 74px;
        border-radius: 50%;
        background: radial-gradient(
            circle at 30% 20%,
            rgba(248, 250, 252, 0.18),
            transparent 55%
          ),
          linear-gradient(145deg, #0f172a, #020617);
        box-shadow: 0 18px 35px rgba(15, 23, 42, 0.9),
          inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        transform: rotate(var(--angle, 0deg));
        transition: transform 60ms linear;
        cursor: pointer;
      }

      .knob-indicator {
        width: 4px;
        height: 22px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 12px rgba(56, 189, 248, 0.9);
      }

      .knob-center-dot {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(15, 23, 42, 0.9);
        border: 2px solid rgba(148, 163, 184, 0.8);
        box-shadow: 0 0 0 4px rgba(15, 23, 42, 0.9);
      }

      .knob-footer {
        display: flex;
        align-items: baseline;
        gap: 6px;
        margin-top: 4px;
      }

      .knob-value {
        font-size: 24px;
        font-weight: 600;
      }

      .knob-unit {
        font-size: 12px;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">ESP32 Multi-Axis Control</div>
        </div>
        <div class="status-chip">
          <span class="status-dot" id="ws-dot"></span>
          <span class="status-text" id="ws-text">Đang kết nối...</span>
        </div>
      </div>

      <div class="knob-grid">
        <!-- Knob 1 -->
        <div class="knob-card" data-channel="ch1">
          <div class="knob-label">Channel 1</div>
          <div class="knob-wrapper">
            <div class="knob-ring"></div>
            <div class="knob-track"></div>
            <div class="knob-track-arc"></div>
            <div class="knob-track-arc-active"></div>
            <div class="knob-core">
              <div class="knob-indicator"></div>
              <div class="knob-center-dot"></div>
            </div>
          </div>
          <div class="knob-footer">
            <span class="knob-value">90</span>
            <span class="knob-unit">deg</span>
          </div>
        </div>

        <!-- Knob 2 -->
        <div class="knob-card" data-channel="ch2">
          <div class="knob-label">Channel 2</div>
          <div class="knob-wrapper">
            <div class="knob-ring"></div>
            <div class="knob-track"></div>
            <div class="knob-track-arc"></div>
            <div class="knob-track-arc-active"></div>
            <div class="knob-core">
              <div class="knob-indicator"></div>
              <div class="knob-center-dot"></div>
            </div>
          </div>
          <div class="knob-footer">
            <span class="knob-value">90</span>
            <span class="knob-unit">deg</span>
          </div>
        </div>

        <!-- Knob 3 -->
        <div class="knob-card" data-channel="ch3">
          <div class="knob-label">Channel 3</div>
          <div class="knob-wrapper">
            <div class="knob-ring"></div>
            <div class="knob-track"></div>
            <div class="knob-track-arc"></div>
            <div class="knob-track-arc-active"></div>
            <div class="knob-core">
              <div class="knob-indicator"></div>
              <div class="knob-center-dot"></div>
            </div>
          </div>
          <div class="knob-footer">
            <span class="knob-value">90</span>
            <span class="knob-unit">deg</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ------------------ WebSocket ------------------
      let ws = null;
      const wsDot = document.getElementById("ws-dot");
      const wsText = document.getElementById("ws-text");

      function setWsStatus(state) {
        if (state === "open") {
          wsDot.style.background = "#22c55e";
          wsDot.style.boxShadow = "0 0 8px rgba(34,197,94,0.9)";
          wsText.textContent = "Đã kết nối";
        } else if (state === "connecting") {
          wsDot.style.background = "#f97316";
          wsDot.style.boxShadow = "0 0 8px rgba(249,115,22,0.9)";
          wsText.textContent = "Đang kết nối...";
        } else {
          wsDot.style.background = "#ef4444";
          wsDot.style.boxShadow = "0 0 8px rgba(239,68,68,0.9)";
          wsText.textContent = "Mất kết nối, thử lại...";
        }
      }

      function initWebSocket() {
        setWsStatus("connecting");
        const url = `ws://192.168.100.190/ws`;
        ws = new WebSocket(url);

        ws.onopen = () => setWsStatus("open");
        ws.onclose = () => {
          setWsStatus("closed");
          setTimeout(initWebSocket, 2000);
        };
        ws.onerror = () => {
          setWsStatus("closed");
        };
        ws.onmessage = (ev) => {
          console.log("ESP32:", ev.data);
        };
      }

      function sendValue(channel, value) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          // Gửi chuỗi dạng ch1:90
          ws.send(`${channel}:${value}`);
        } else {
          console.warn("WebSocket chưa sẵn sàng");
        }
      }

      // ------------------ Knob logic ------------------
      const MIN_ANGLE = -135;
      const MAX_ANGLE = 135;
      const VALUE_MIN = 0;
      const VALUE_MAX = 180;

      const knobCards = document.querySelectorAll(".knob-card");

      function clamp(v, min, max) {
        return Math.min(max, Math.max(min, v));
      }

      function valueToAngle(value) {
        const ratio = (value - VALUE_MIN) / (VALUE_MAX - VALUE_MIN);
        return MIN_ANGLE + ratio * (MAX_ANGLE - MIN_ANGLE);
      }

      function angleToValue(angle) {
        const ratio = (angle - MIN_ANGLE) / (MAX_ANGLE - MIN_ANGLE);
        return Math.round(VALUE_MIN + ratio * (VALUE_MAX - VALUE_MIN));
      }

      function angleFromPointer(center, pointer) {
        const dx = pointer.x - center.x;
        const dy = pointer.y - center.y;
        let deg = (Math.atan2(dy, dx) * 180) / Math.PI;
        deg -= 90;
        if (deg < -180) deg += 360;
        return deg;
      }

      knobCards.forEach((card) => {
        const wrapper = card.querySelector(".knob-wrapper");
        const core = card.querySelector(".knob-core");
        const activeArc = card.querySelector(".knob-track-arc-active");
        const valueSpan = card.querySelector(".knob-value");
        const channel = card.dataset.channel || "unknown";

        let isDragging = false;
        let currentValue = 90;
        let currentAngle = valueToAngle(currentValue);

        core.style.setProperty("--angle", `${currentAngle}deg`);
        activeArc.style.setProperty(
          "--angle",
          `${currentAngle - MIN_ANGLE}deg`
        );
        valueSpan.textContent = currentValue;

        function updateFromPointer(ev) {
          const rect = wrapper.getBoundingClientRect();
          const center = {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2,
          };
          const pointer = { x: ev.clientX, y: ev.clientY };
          let rawAngle = angleFromPointer(center, pointer);
          let clamped = clamp(rawAngle, MIN_ANGLE, MAX_ANGLE);

          currentAngle = clamped;
          currentValue = angleToValue(clamped);

          core.style.setProperty("--angle", `${currentAngle}deg`);
          activeArc.style.setProperty(
            "--angle",
            `${currentAngle - MIN_ANGLE}deg`
          );
          valueSpan.textContent = currentValue;

          sendValue(channel, currentValue);
        }

        function onPointerDown(ev) {
          ev.preventDefault();
          isDragging = true;
          wrapper.setPointerCapture(ev.pointerId);
          updateFromPointer(ev);
        }

        function onPointerMove(ev) {
          if (!isDragging) return;
          ev.preventDefault();
          updateFromPointer(ev);
        }

        function onPointerUp(ev) {
          if (!isDragging) return;
          isDragging = false;
          wrapper.releasePointerCapture(ev.pointerId);
        }

        wrapper.addEventListener("pointerdown", onPointerDown);
        wrapper.addEventListener("pointermove", onPointerMove);
        wrapper.addEventListener("pointerup", onPointerUp);
        wrapper.addEventListener("pointercancel", onPointerUp);
        wrapper.addEventListener("lostpointercapture", onPointerUp);
      });

      window.addEventListener("load", () => {
        initWebSocket();
      });
    </script>
  </body>
</html>
